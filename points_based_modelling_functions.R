################# Functions

# Service Game
service_game <- function(p_s) {
  return(p_s^4 + 4*p_s^4*(1-p_s) + 10*p_s^4*(1-p_s)^2 + (20*p_s^5*(1-p_s)^3)/(1-2*p_s+2*p_s^2))
}

# Return Game
return_game <- function(p_r) {
  return(p_r^4 + 4*p_r^4*(1-p_r) + 10*p_r^4*(1-p_r)^2 + (20*p_r^5*(1-p_r)^3)/(1-2*p_r+2*p_r^2))
}

# Tie Breaker
tie_breaker <- function(p_s,p_r) {
  p_t = 0.5*p_s + 0.5*p_r
  return(p_t^7 + 7*p_t^7*(1-p_t) + 28*p_t^7*(1-p_t)^2 + 84*p_t^7*(1-p_t)^3 + 210*p_t^7*(1-p_t)^4 + 462*p_t^7*(1-p_t)^5 + (924*p_t^8*(1-p_t)^6)/(1-2*p_t+2*p_t^2))
}

# Set
set <- function(p_s,p_r) {
  s = service_game(p_s)
  r = return_game(p_r)
  t = tie_breaker(p_s,p_r)
  s_firstserve = 
    1* s^3 * r^3 + 3* s^3 * r^3 * (1-s)^1 + 3* s^4 * r^2 * (1-r)^1 + 12* s^3 * r^3 * (1-s)^1 * (1-r)^1 + 6* s^2 * r^4 * (1-s)^2 + 3* s^4 * r^2 * (1-r)^2 + 24* s^3 * r^3 * (1-s)^2 * (1-r)^1 + 24* s^4 * r^2 * (1-s)^1 * (1-r)^2 + 4* s^2 * r^4 * (1-s)^3 + 4* s^5 * r^1 * (1-r)^3 + 60* s^3 * r^3 * (1-s)^2 * (1-r)^2 + 40* s^2 * r^4 * (1-s)^3 * (1-r)^1 + 20* s^4 * r^2 * (1-s)^1 * (1-r)^3 + 5* s^1 * r^5 * (1-s)^4 + 1* s^5 * r^1 * (1-r)^4 + 100* s^3 * r^4 * (1-s)^3 * (1-r)^2 + 100* s^4 * r^3 * (1-s)^2 * (1-r)^3 + 25* s^2 * r^5 * (1-s)^4 * (1-r)^1 + 25* s^5 * r^2 * (1-s)^1 * (1-r)^4 + 1* s^1 * r^6 * (1-s)^5 + 1* s^6 * r^1 * (1-r)^5 + 200* s^3 * r^3 * (1-s)^3 * (1-r)^3 * t + 125* s^4 * r^2 * (1-s)^2 * (1-r)^4 * t + 125* s^2 * r^4 * (1-s)^4 * (1-r)^2 * t + 26* s^5 * r^1 * (1-s)^1 * (1-r)^5 * t + 26* s^1 * r^5 * (1-s)^5 * (1-r)^1 * t + 1* s^6 * (1-r)^6 * t + 1 * r^6 * (1-s)^6 * t
  s_firstreturn = 
    1* s^3 * r^3 + 3* s^3 * r^3 * (1-r)^1 + 3* s^2 * r^4 * (1-s)^1 + 12* s^3 * r^3 * (1-s)^1 * (1-r)^1 + 6* s^4 * r^2 * (1-r)^2 + 3* s^2 * r^4 * (1-s)^2 + 24* s^3 * r^3 * (1-s)^1 * (1-r)^2 + 24* s^2 * r^4 * (1-s)^2 * (1-r)^1 + 4* s^4 * r^2 * (1-r)^3 + 4* s^1 * r^5 * (1-s)^3 + 60* s^3 * r^3 * (1-s)^2 * (1-r)^2 + 40* s^4 * r^2 * (1-s)^1 * (1-r)^3 + 20* s^2 * r^4 * (1-s)^3 * (1-r)^1 + 5* s^5 * r^1 * (1-r)^4 + 1* s^1 * r^5 * (1-s)^4 + 100* s^4 * r^3 * (1-s)^2 * (1-r)^3 + 100* s^3 * r^4 * (1-s)^3 * (1-r)^2 + 25* s^5 * r^2 * (1-s)^1 * (1-r)^4 + 25* s^2 * r^5 * (1-s)^4 * (1-r)^1 + 1* s^6 * r^1 * (1-r)^5 + 1* s^1 * r^6 * (1-s)^5 + 200* s^3 * r^3 * (1-s)^3 * (1-r)^3 * t + 125* s^2 * r^4 * (1-s)^4 * (1-r)^2 * t + 125* s^4 * r^2 * (1-s)^2 * (1-r)^4 * t + 26* s^1 * r^5 * (1-s)^5 * (1-r)^1 * t + 26* s^5 * r^1 * (1-s)^1 * (1-r)^5 * t + 1 * r^6 * (1-s)^6 * t + 1* s^6 * (1-r)^6 * t
  return(0.5*s_firstserve + 0.5*s_firstreturn)
}

# Match
match <- function(p_s, p_r, best_of = 3) {
  x = set(p_s,p_r)
  if (best_of == 5) {
    return(10*x^3 - 15*x^4 + 6*x^5)    
  } else {
    return(3*x^2 - 2*x^3)
  }
}

# Test
match(best_of = 5, p_s = 0.63, p_r = 0.41)

